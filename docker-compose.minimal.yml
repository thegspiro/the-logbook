# ============================================
# MINIMAL PROFILE - Docker Compose Override
# ============================================
# Use for: Raspberry Pi, small VPS (1-2GB RAM)
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.minimal.yml up -d
#
# Or set in .env:
#   COMPOSE_FILE=docker-compose.yml:docker-compose.minimal.yml
# ============================================

services:
  # MySQL with minimal resources
  # Note: On ARM/Raspberry Pi, layer the ARM override which switches to MariaDB:
  #   docker compose -f docker-compose.yml -f docker-compose.minimal.yml -f docker-compose.arm.yml up -d
  mysql:
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --max_connections=50
      --max_allowed_packet=16M
      --innodb_buffer_pool_size=128M
      --innodb_redo_log_capacity=33554432
      --tmp_table_size=16M
      --max_heap_table_size=16M
      --table_open_cache=64
      --skip-name-resolve
      --skip-log-bin
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Redis with memory limits
  redis:
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:-change_me_in_production}
      --maxmemory 64mb
      --maxmemory-policy allkeys-lru
      --save ""
      --appendonly no
    deploy:
      resources:
        limits:
          memory: 96M
        reservations:
          memory: 32M

  # Backend with single worker
  backend:
    # Exec form so uvicorn receives SIGTERM for graceful shutdown
    command: ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "3001", "--workers", "1"]
    init: true
    stop_grace_period: 15s
    environment:
      WORKERS: 1
      WEB_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 384M
        reservations:
          memory: 192M

  # Frontend with minimal nginx
  frontend:
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
