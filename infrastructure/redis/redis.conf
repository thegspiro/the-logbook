# =============================================================================
# Redis Configuration for The Logbook
# =============================================================================
# SEC: This configuration enforces per-service ACL users to limit the blast
# radius if any single service credential is compromised.
#
# Users:
#   - default: Disabled (blocks unauthenticated access)
#   - app:     Backend API (cache, sessions, pub/sub) — full key access
#   - celery:  Task queue worker — restricted to celery-* key patterns
#
# Passwords are injected via environment variable substitution at container
# startup (see docker-compose.yml command override).
# =============================================================================

# Bind to all interfaces (Docker networking handles isolation)
bind 0.0.0.0

# Disable default user — force explicit authentication
user default off

# App user: full access for the backend API
# Password set via --requirepass or ACL SETUSER at runtime
user app on >REDIS_APP_PASSWORD ~* +@all

# Celery user: restricted to celery key patterns and basic commands
user celery on >REDIS_CELERY_PASSWORD ~celery* ~_kombu* ~unacked* +@read +@write +@connection +@generic +del +expire +ttl +type +scan +hscan +sscan +zscan +keys +exists +ping +select +info +client

# Memory management
maxmemory-policy allkeys-lru

# Persistence
appendonly yes
appendfsync everysec

# Security: disable dangerous commands
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command CONFIG "CONFIG_b4d8e2f1"
rename-command DEBUG ""
rename-command SHUTDOWN "SHUTDOWN_a7c3e9d2"
