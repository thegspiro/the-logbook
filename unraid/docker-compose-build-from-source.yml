# ============================================
# THE LOGBOOK - DOCKER COMPOSE (BUILD FROM SOURCE)
# For Unraid - Builds images locally instead of pulling from ghcr.io
# ============================================

services:
  # ============================================
  # Database (MariaDB)
  # ============================================
  db:
    image: mariadb:10.11
    container_name: logbook-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${DB_NAME:-the_logbook}
      MYSQL_USER: ${DB_USER:-logbook_user}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      TZ: ${TZ:-America/New_York}
    volumes:
      - /mnt/user/appdata/the-logbook/mysql:/var/lib/mysql
    networks:
      - logbook-internal
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --innodb_buffer_pool_size=512M
      --max_connections=200
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Redis Cache
  # ============================================
  redis:
    image: redis:7-alpine
    container_name: logbook-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    environment:
      REDIS_PASSWORD: ${REDIS_PASSWORD}
    volumes:
      - /mnt/user/appdata/the-logbook/redis:/data
    networks:
      - logbook-internal
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a $${REDIS_PASSWORD} --no-auth-warning ping | grep PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Backend API (FastAPI)
  # BUILDS FROM SOURCE - No ghcr.io pull needed
  # ============================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: production
    container_name: logbook-backend
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Database
      DB_HOST: db
      DB_PORT: 3306
      DB_NAME: ${DB_NAME:-the_logbook}
      DB_USER: ${DB_USER:-logbook_user}
      DB_PASSWORD: ${DB_PASSWORD}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}

      # Application
      SECRET_KEY: ${SECRET_KEY}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      ENCRYPTION_SALT: ${ENCRYPTION_SALT}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      APP_NAME: ${APP_NAME:-The Logbook}
      VERSION: ${VERSION:-1.0.0}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      DEBUG: ${DEBUG:-false}

      # Email (optional)
      EMAIL_ENABLED: ${EMAIL_ENABLED:-false}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}

      # Storage
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-52428800}

      # Backup
      BACKUP_ENABLED: ${BACKUP_ENABLED:-true}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}

      # Module Toggles
      MODULE_TRAINING_ENABLED: ${MODULE_TRAINING_ENABLED:-true}
      MODULE_COMPLIANCE_ENABLED: ${MODULE_COMPLIANCE_ENABLED:-true}
      MODULE_SCHEDULING_ENABLED: ${MODULE_SCHEDULING_ENABLED:-true}
      MODULE_ELECTIONS_ENABLED: ${MODULE_ELECTIONS_ENABLED:-true}

      # Misc
      ENABLE_DOCS: ${ENABLE_DOCS:-true}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      TZ: ${TZ:-America/New_York}

    # Exec form CMD in Dockerfile ensures uvicorn is PID 1 and receives SIGTERM
    stop_grace_period: 15s
    volumes:
      - /mnt/user/appdata/the-logbook/data:/app/data
      - /mnt/user/appdata/the-logbook/uploads:/app/uploads
      - /mnt/user/appdata/the-logbook/logs:/app/logs
      - /mnt/user/backups/the-logbook:/backups
    ports:
      - "${BACKEND_PORT:-7881}:3001"
    networks:
      - logbook-internal
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:3001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # Frontend (React + Nginx)
  # BUILDS FROM SOURCE - No ghcr.io pull needed
  # ============================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
      args:
        VITE_API_URL: http://${ALLOWED_ORIGINS:-192.168.1.10}:${BACKEND_PORT:-7881}
    container_name: logbook-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "${FRONTEND_PORT:-7880}:80"
    networks:
      - logbook-internal
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  logbook-internal:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
